---
title: "Stable coexistence between four native and one invasive species seen through the lens of isotopic niche analyses #4: Compute niche metrics"
author: "Nadege Belouard"
date: "11/20/2020"
output: html_document
---

This vignette computes all isotopic niche metrics relative to populations and communities.
We first load the packages and the dataset, and check if the dataset has the correct number of lines.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(viridis)
palette(viridis(3))
set.seed(1)
library(siar)
library(SIBER)
library(dplyr)

Dataset<-read.table("C:/Users/Utlisateur/Documents/Nadege/2_Ressources_professionnelles/Reseaux trophiques/Analyses/exported_data/Isotope_data_standardized.txt", header=T)
dim(Dataset)[1] == 1807

```


# 1- Community metrics

We calculate community metrics from the average point for each taxa.
We begin with the 6 metrics of Layman. We need to create a 4-column table with the two isotopes (C and N), the group (taxa), and the community (pond). Then we calculate the community metrics.

```{r 6 community metrics Layman, include=FALSE}

Community_dataset <- Dataset %>% dplyr::select("iso1" = D13Ccor_consoI, "iso2" = TP, 
                                               "group" = Taxa, "community" = Pond)
Community_metrics_dataset <- createSiberObject(Community_dataset)
Community_metrics_dataset$sample.sizes 

#Should we suppress taxa with <3 ind?
#Should we include the primary producers? (if yes, NR = FCL?)

Community_metrics <- communityMetricsML(Community_metrics_dataset) #This is the first set of metrics
```


Then we calculate the TA, SEA, and SEAc from Layman. Here we calculate manually the average point for each taxa. The "group" is the pond, here.

```{r calculate community ellipses, include=FALSE}

Community_dataset_SEAc <- Dataset %>% group_by(Taxa, Pond) %>%
  summarise(D13C = mean(D13Ccor_consoI),
            TP = mean(TP)) %>%
  mutate("community" = "M") %>%
  ungroup() %>%
  dplyr::select("iso1" = D13C, "iso2" = TP, "group" = Pond, "community" = community) %>%
  as.data.frame()

Community_SEAc_dataset <- createSiberObject(Community_dataset_SEAc)
Community_SEAc_dataset$sample.sizes

Community_metrics_SEAc <- groupMetricsML(Community_SEAc_dataset)
```

Then, we calculate the FCL (= food chain length, = MTP, maximum trophic position)

```{r calculate FCL, include=FALSE}

Community_FCL <- Dataset %>% group_by(Taxa, Pond) %>%
  summarise(TPavg = mean(TP)) %>% 
  group_by(Pond) %>%
  summarise(FCL = max(TPavg))

```


Finally, we merge all 3 types of community metrics into one dataset and we save it.

```{r merge datasets, include=FALSE}

Com_metrics_6 <- t(Community_metrics) %>%
  as.data.frame() %>%
  dplyr::mutate(Pond = colnames(Community_metrics)) %>%
  rename(NR = dY_range, CR = dX_range)

Com_SEAc <- t(Community_metrics_SEAc) %>%
  as.data.frame() %>%
  dplyr::mutate(Pond = colnames(Community_metrics_SEAc)) %>%
  dplyr::select(-TA)
Com_SEAc$Pond <- gsub(pattern = "M.", replacement = "", Com_SEAc$Pond)

Community_FCL

Com_metrics <- merge(Com_metrics_6, Com_SEAc, by = "Pond")
Com_metrics <- merge(Com_metrics, Community_FCL, by = "Pond")


write.table(Com_metrics,"../exported_data/Community_metrics.txt")
```



# 2- Population metrics

We calculate population metrics for amphibians and crayfish.

We begin with selecting the species of interest and removing populations with inadequate samples, i.e. large populations with n < 10. Some populations have n < 10 but are kept because we have good indicators from CMR that the sample size is representative of the population.

```{r select appropriate populations, include=FALSE}

Pop_Dataset <- Dataset %>% dplyr::filter(Taxa %in% c("Grenouille_agile", "Rainette_verte",
                                                  "Triton_palmé", "Triton_marbré",
                                                  "Ecrevisse_Ad", "Ecrevisse_Juv"))


Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Ecrevisse_Ad"|!Pop_Dataset$Pond=="70",]

Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Ecrevisse_Juv"|!Pop_Dataset$Pond=="66",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Ecrevisse_Juv"|!Pop_Dataset$Pond=="70",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Ecrevisse_Juv"|!Pop_Dataset$Pond=="72",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Ecrevisse_Juv"|!Pop_Dataset$Pond=="82_2016",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Ecrevisse_Juv"|!Pop_Dataset$Pond=="888",]

Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Grenouille_agile"|!Pop_Dataset$Pond=="22",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Grenouille_agile"|!Pop_Dataset$Pond=="82_2016",]

Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Triton_marbré"|!Pop_Dataset$Pond=="111",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Triton_marbré"|!Pop_Dataset$Pond=="112",]
#Marbré 56 kept
#Marbré 94 kept

Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Triton_palmé"|!Pop_Dataset$Pond=="72",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Triton_palmé"|!Pop_Dataset$Pond=="888",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Triton_palmé"|!Pop_Dataset$Pond=="88",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Triton_palmé"|!Pop_Dataset$Pond=="89",]
Pop_Dataset<-Pop_Dataset[!Pop_Dataset$Taxa=="Triton_palmé"|!Pop_Dataset$Pond=="82_2016",]
#Palmé 112 kept

table(Pop_Dataset$Pond, Pop_Dataset$Taxa)
```

Check if the number of populations is correct

```{r check number of individuals is correct, include=FALSE}
dim(Pop_Dataset)
dim(Pop_Dataset[Pop_Dataset$Taxa=="Grenouille_agile",])[1] == 274 
dim(Pop_Dataset[Pop_Dataset$Taxa=="Rainette_verte",])[1] == 186
dim(Pop_Dataset[Pop_Dataset$Taxa=="Triton_palmé",])[1] == 209
dim(Pop_Dataset[Pop_Dataset$Taxa=="Triton_marbré",])[1] == 101
dim(Pop_Dataset[Pop_Dataset$Taxa=="Ecrevisse_Ad",])[1] == 246
dim(Pop_Dataset[Pop_Dataset$Taxa=="Ecrevisse_Juv",])[1] == 153
```

We first calculate the six metrics of Layman (TA, CR, NR, CD, MNND, SDNND) on each population for each pond. This is done by providing a vector containing the list of populations and ponds.

```{r calculate Layman metrics for populations, include=FALSE}

spx <- split(Pop_Dataset$D13Ccor_consoI, 
             list(Pop_Dataset$Pond, Pop_Dataset$Taxa), drop = TRUE)
length(spx)

spy <- split(Pop_Dataset$TP, list(Pop_Dataset$Pond, Pop_Dataset$Taxa), drop = TRUE)
length(spy)

Table <- data.frame(metrics = c("dX_range", "dY_range", "NND", "SDNND", "CD", "TA"))

for (i in 1:length(spx)) {  
  Metrics <- laymanMetrics(spx[[i]],spy[[i]])
  Data <- as.data.frame(Metrics$metrics)
  Data$metrics <- rownames(Data)
  colnames(Data)[1] <- names(spx[i])
  Table <- merge(Table, Data, by = 'metrics', suffixes = colnames(Data)[1], all=TRUE)
}

Pop_metrics_Layman<-as.data.frame(t(Table))
colnames(Pop_metrics_Layman) <- Pop_metrics_Layman[1,]
Pop_metrics_Layman <- Pop_metrics_Layman[-1,]
Pop_metrics_Layman$Code <- rownames(Pop_metrics_Layman)
```


Now we calculate the equivalent using the bootstrapping method. For each pop, we sample 10 individuals in the population, calculate the 6 metrics of Layman, then do it again 999 times.

```{r calculate Layman metrics with bootstrapping for populations, include=FALSE}

# We group samples by pond and species again
spx <- split(Pop_Dataset$D13Ccor_consoI, 
             list(Pop_Dataset$Pond, Pop_Dataset$Taxa), drop = TRUE)
dim(spx)

spy <- split(Pop_Dataset$TP, list(Pop_Dataset$Pond, Pop_Dataset$Taxa), drop = TRUE)
length(spy)

# Number of bootstrapped required
nr <- 1000 # the number of reps

# Create empty vectors to store the results
dNR <- data.frame(matrix(NA, ncol=66,nrow=1000))
dCR <- data.frame(matrix(NA, ncol=66,nrow=1000))
TA <- data.frame(matrix(NA, ncol=66,nrow=1000))
CD <- data.frame(matrix(NA, ncol=66,nrow=1000))
MNND <- data.frame(matrix(NA, ncol=66,nrow=1000))
SDNND <- data.frame(matrix(NA, ncol=66,nrow=1000))

names(dNR)<-names(spx)
names(dCR)<-names(spx)
names(TA)<-names(spx)
names(CD)<-names(spx)
names(MNND)<-names(spx)
names(SDNND)<-names(spx)

for (j in 1:length(spx)) {
  if (length(spx[[j]]) > 10) {
    for (i in 1:nr) {
      simX<-sample(spx[[j]], 10, replace = FALSE, prob = NULL)
      simY<-sample(spy[[j]],10,replace = FALSE,prob=NULL)
      layman <- laymanmetrics(simX, simY)
      dNR[i,j] <- layman$dN_range
      dCR[i,j] <- layman$dC_range
      TA[i,j] <- layman$hull$TA
      CD[i,j] <- layman$CD
      MNND[i,j] <- layman$MNND
      SDNND[i,j] <- layman$SDNND
    }
  }
}

# write.table(dNR, "../exported_data/NR_bootstrapped_10s.txt")
# write.table(dCR,"../exported_data/CR_bootstrapped_10s.txt")
# write.table(TA,"../exported_data/TA_bootstrapped_10s.txt")
# write.table(CD,"../exported_data/CD_bootstrapped_10s.txt")
# write.table(MNND,"../exported_data/MNND_bootstrapped_10s.txt")
# write.table(SDNND,"../exported_data/SDNND_bootstrapped_10s.txt")
```


```{r calculate average bootstrapped Layman metrics for populations, include=FALSE}

Pop_metrics_bootstrapped <- as.data.frame(cbind(NRb = colMeans(dNR), 
                                  CRb = colMeans(dCR), 
                                  TAb = colMeans(TA),
                                  CDb = colMeans(CD), 
                                  MNNDb = colMeans(MNND), 
                                  SDNNDb = colMeans(SDNND),
                                  Code = colnames(dNR)))
```


Finally, we calculate TA, SEA and SEAc for populations from Layman. 

```{r calculate population ellipses, include=FALSE}

Pop_Dataset_ellipses <- Pop_Dataset %>% 
  dplyr::select("iso1" = D13Ccor_consoI, "iso2" = TP, "group" = Taxa, "community" = Pond) %>%
  as.data.frame()

Pop_dataset_SIBER <- createSiberObject(Pop_Dataset_ellipses)
Pop_metrics_SEAc <- groupMetricsML(Pop_dataset_SIBER)

#Table transformation
Pop_metrics_ellipses <- as.data.frame(t(Pop_metrics_SEAc))
Pop_metrics_ellipses$Code <- rownames(Pop_metrics_ellipses)
Pop_metrics_ellipses$Pond <- gsub("[.].*","",Pop_metrics_ellipses$Code)
Pop_metrics_ellipses$Taxa <- gsub(".*.[.]","",Pop_metrics_ellipses$Code)
```


Finally, we merge the three datasets.


```{r merge datasets, include=FALSE}

Pop_metrics <- merge(Pop_metrics_Layman, Pop_metrics_bootstrapped, by = "Code")
dim(Pop_metrics)

#Create a composite metric to avoid NAs in bootstrapped metrics
Pop_metrics$NRcp = Pop_metrics$NRb 
Pop_metrics$CRcp = Pop_metrics$CRb
Pop_metrics$TAcp = Pop_metrics$TAb
Pop_metrics$CDcp = Pop_metrics$CDb
Pop_metrics$MNNDcp = Pop_metrics$MNNDb
Pop_metrics$SDNNDcp = Pop_metrics$SDNNDb

for (i in 1:length(Pop_metrics$NRb)) {
  if (is.na(Pop_metrics$NRb[i]) == TRUE) {
    Pop_metrics$NRcp[i] <- Pop_metrics$dY_range[i]
    Pop_metrics$CRcp[i] <- Pop_metrics$dX_range[i]
    Pop_metrics$TAcp[i] <- Pop_metrics$TA[i]
    Pop_metrics$CDcp[i] <- Pop_metrics$CD[i]
    Pop_metrics$MNNDcp[i] <- Pop_metrics$NND[i]
    Pop_metrics$SDNNDcp[i] <- Pop_metrics$SDNND[i]
  }
}

Pop_metrics <- merge(Pop_metrics, Pop_metrics_ellipses[-1], by = "Code")

write.table(Pop_metrics,"../exported_data/Population_metrics.txt")
```



# 3- Coordinates of the standard ellipses (SEAc) 

```{r merge datasets, include=FALSE}

spx <- split(Pop_Dataset$D13Ccor_consoI, list(Pop_Dataset$Pond,Pop_Dataset$Taxa),drop=TRUE)
spy <- split(Pop_Dataset$TP, list(Pop_Dataset$Pond,Pop_Dataset$Taxa),drop=TRUE)

Pop<-NULL
coordY<-NULL
coordX<-NULL
j=1

for (i in 1:length(spx)) {
  SE <- standard.ellipse(spx[[i]],spy[[i]],steps=1)
  Pop[j:(j+360)]<-names(spx)[i]
  coordY[j:(j+360)]<-SE$ySEAc[1:361]
  coordX[j:(j+360)]<-SE$xSEAc[1:361]
  j=j+361
}

CoordSEAc<-cbind(Pop,coordY,coordX)
summary(CoordSEAc)
CoordSEAc<-as.data.frame(CoordSEAc)
CoordSEAc$coordY<-as.numeric(as.character(CoordSEAc$coordY))
CoordSEAc$coordX<-as.numeric(as.character(CoordSEAc$coordX))
str(CoordSEAc)
CoordSEAc$Pond<-gsub("\\..*","",CoordSEAc$Pop)
CoordSEAc$Species<-gsub(".*\\.","",CoordSEAc$Pop)
head(CoordSEAc)
CoordSEAc$Pond<-as.factor(CoordSEAc$Pond)
levels(CoordSEAc$Pond)
write.table(CoordSEAc,"../exported_data/Coordinates_SEAc_consoI.txt")

``` 


```{r centroides of standard ellipses}

Mean_position <- CoordSEAc %>% group_by(Pond, Species, Pop) %>%
  summarise(TPavg = mean(coordY),
            D13Cavg = mean(coordX))

dim(Mean_position)[1]

write.table(Mean_position,"../exported_data/Meanposition_SEAc.txt")

```




#4- Area of ellipses overlap

````{r area of ellipses overlap: initialize vectors}

library(spatstat.utils)

#Split dataset by species
Ecrevisse_Ad <- Pop_Dataset[Pop_Dataset$Taxa=="Ecrevisse_Ad",]
Ecrevisse_Juv <- Pop_Dataset[Pop_Dataset$Taxa=="Ecrevisse_Juv",]                    
Rainette_verte <- Pop_Dataset[Pop_Dataset$Taxa=="Rainette_verte",] 
Grenouille_agile <- Pop_Dataset[Pop_Dataset$Taxa=="Grenouille_agile",] 
Triton_palme <- Pop_Dataset[Pop_Dataset$Taxa=="Triton_palmé",] 
Triton_marbre <- Pop_Dataset[Pop_Dataset$Taxa=="Triton_marbré",] 

#For each species, split dataset by pond
spx_Ecrevisse_Ad <- split(Ecrevisse_Ad$D13Ccor_consoI, list(Ecrevisse_Ad$Pond),drop=FALSE)
spy_Ecrevisse_Ad <- split(Ecrevisse_Ad$TP, list(Ecrevisse_Ad$Pond),drop=FALSE)
spx_Ecrevisse_Juv <- split(Ecrevisse_Juv$D13Ccor_consoI, list(Ecrevisse_Juv$Pond),drop=FALSE)
spy_Ecrevisse_Juv <- split(Ecrevisse_Juv$TP, list(Ecrevisse_Juv$Pond),drop=FALSE)
spx_Grenouille_agile <- split(Grenouille_agile$D13Ccor_consoI, list(Grenouille_agile$Pond),drop=FALSE)
spy_Grenouille_agile <- split(Grenouille_agile$TP, list(Grenouille_agile$Pond),drop=FALSE)
spx_Rainette_verte <- split(Rainette_verte$D13Ccor_consoI, list(Rainette_verte$Pond),drop=FALSE)
spy_Rainette_verte <- split(Rainette_verte$TP, list(Rainette_verte$Pond),drop=FALSE)
spx_Triton_palme <- split(Triton_palme$D13Ccor_consoI, list(Triton_palme$Pond),drop=FALSE)
spy_Triton_palme <- split(Triton_palme$TP, list(Triton_palme$Pond),drop=FALSE)
spx_Triton_marbre <- split(Triton_marbre$D13Ccor_consoI, list(Triton_marbre$Pond),drop=FALSE)
spy_Triton_marbre <- split(Triton_marbre$TP, list(Triton_marbre$Pond),drop=FALSE)

#Initialize vectors
Pond = NULL
Species1 = NULL
Species2 = NULL
AreaOverlap = NULL
AreaSp1 = NULL
AreaSp2 = NULL
Table = data.frame()
```



```{r area of ellipses overlap: loop over crayfish adults}

for (i in names(spx_Ecrevisse_Ad)) {
  if (length(spx_Grenouille_agile[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Ad", after = length(Species1))
    Species2 <- append(Species2, "Grenouille_agile", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Ad[[i]], spy_Ecrevisse_Ad[[i]],
                             spx_Grenouille_agile[[i]], spy_Grenouille_agile[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Rainette_verte[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Ad", after = length(Species1))
    Species2 <- append(Species2, "Rainette_verte", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Ad[[i]], spy_Ecrevisse_Ad[[i]],
                             spx_Rainette_verte[[i]], spy_Rainette_verte[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Triton_palme[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Ad", after = length(Species1))
    Species2 <- append(Species2, "Triton_palme", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Ad[[i]], spy_Ecrevisse_Ad[[i]],
                             spx_Triton_palme[[i]], spy_Triton_palme[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Triton_marbre[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Ad", after = length(Species1))
    Species2 <- append(Species2, "Triton_marbre", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Ad[[i]], spy_Ecrevisse_Ad[[i]],
                             spx_Triton_marbre[[i]], spy_Triton_marbre[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  
  if (length(spx_Ecrevisse_Juv[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Ad", after = length(Species1))
    Species2 <- append(Species2, "Ecrevisse_Juv", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Ad[[i]], spy_Ecrevisse_Ad[[i]],
                             spx_Ecrevisse_Juv[[i]], spy_Ecrevisse_Juv[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}

```



```{r area of ellipses overlap: loop over crayfish juveniles}

for (i in names(spx_Ecrevisse_Juv)) {
  if (length(spx_Grenouille_agile[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Juv", after = length(Species1))
    Species2 <- append(Species2, "Grenouille_agile", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Juv[[i]], spy_Ecrevisse_Juv[[i]],
                             spx_Grenouille_agile[[i]], spy_Grenouille_agile[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Rainette_verte[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Juv", after = length(Species1))
    Species2 <- append(Species2, "Rainette_verte", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Juv[[i]], spy_Ecrevisse_Juv[[i]],
                             spx_Rainette_verte[[i]], spy_Rainette_verte[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Triton_palme[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Juv", after = length(Species1))
    Species2 <- append(Species2, "Triton_palme", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Juv[[i]], spy_Ecrevisse_Juv[[i]],
                             spx_Triton_palme[[i]], spy_Triton_palme[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Triton_marbre[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Ecrevisse_Juv", after = length(Species1))
    Species2 <- append(Species2, "Triton_marbre", after = length(Species2))
    Overlap <- siar::overlap(spx_Ecrevisse_Juv[[i]], spy_Ecrevisse_Juv[[i]],
                             spx_Triton_marbre[[i]], spy_Triton_marbre[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}

```



```{r area of ellipses overlap: loop between amphibians}

for (i in names(spx_Grenouille_agile)) {
  if (length(spx_Rainette_verte[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Grenouille_agile", after = length(Species1))
    Species2 <- append(Species2, "Rainette_verte", after = length(Species2))
    Overlap <- siar::overlap(spx_Grenouille_agile[[i]], spy_Grenouille_agile[[i]],
                             spx_Rainette_verte[[i]], spy_Rainette_verte[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Triton_palme[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Grenouille_agile", after = length(Species1))
    Species2 <- append(Species2, "Triton_palme", after = length(Species2))
    Overlap <- siar::overlap(spx_Grenouille_agile[[i]], spy_Grenouille_agile[[i]],
                             spx_Triton_palme[[i]], spy_Triton_palme[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Triton_marbre[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Grenouille_agile", after = length(Species1))
    Species2 <- append(Species2, "Triton_marbre", after = length(Species2))
    Overlap <- siar::overlap(spx_Grenouille_agile[[i]], spy_Grenouille_agile[[i]],
                             spx_Triton_marbre[[i]], spy_Triton_marbre[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}



for (i in names(spx_Rainette_verte)) {
  if (length(spx_Triton_palme[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Rainette_verte", after = length(Species1))
    Species2 <- append(Species2, "Triton_palme", after = length(Species2))
    Overlap <- siar::overlap(spx_Rainette_verte[[i]], spy_Rainette_verte[[i]],
                             spx_Triton_palme[[i]], spy_Triton_palme[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Triton_marbre[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Rainette_verte", after = length(Species1))
    Species2 <- append(Species2, "Triton_marbre", after = length(Species2))
    Overlap <- siar::overlap(spx_Rainette_verte[[i]], spy_Rainette_verte[[i]],
                             spx_Triton_marbre[[i]], spy_Triton_marbre[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}


for (i in names(spx_Triton_palme)) {
  if (length(spx_Triton_marbre[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Triton_palme", after = length(Species1))
    Species2 <- append(Species2, "Triton_marbre", after = length(Species2))
    Overlap <- siar::overlap(spx_Triton_palme[[i]], spy_Triton_palme[[i]],
                             spx_Triton_marbre[[i]], spy_Triton_marbre[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}

```


Analyses of overlap areas

``` {r analyses of overlaps}

Table<-cbind(Pond, Species1, Species2, AreaOverlap = round(AreaOverlap,4), 
             AreaSp1 = round(AreaSp1,4), AreaSp2 = round(AreaSp2,4))

Table <- as.data.frame(Table)
Table$Prct_overlap <- round(as.numeric(Table$AreaOverlap) / (as.numeric(Table$AreaSp1)+as.numeric(Table$AreaSp2)),4)
Table

write.table(Table, "../exported_data/Overlap.txt")
```